using System.Text.Json;
using WowAHaha.GameDataApi;
using WowAHaha.GameDataApi.Statistics;
using JsonSerializerOptions = System.Text.Json.JsonSerializerOptions;

namespace WowAHaha.Tests;

public class RunningAuctionStatsBagJsonConverterTests
{
    [Fact]
    public void Serialize_ShouldReadCorrectly()
    {
        // Arrange
        var payload = """

                      {"_links":{"self":{"href":"https://us.api.blizzard.com/data/wow/auctions/commodities?namespace=dynamic-us"}},"auctions":[{"id":1015580187,"item":{"id":13926},"quantity":1,"unit_price":1387900,"time_left":"VERY_LONG"},{"id":1014910895,"item":{"id":111522},"quantity":3,"unit_price":700,"time_left":"LONG"},{"id":1015044290,"item":{"id":53066},"quantity":40,"unit_price":2200,"time_left":"LONG"},{"id":1014735972,"item":{"id":116406},"quantity":3,"unit_price":1000100,"time_left":"LONG"},{"id":1015027494,"item":{"id":8766},"quantity":8,"unit_price":200,"time_left":"LONG"},{"id":1013103405,"item":{"id":225850},"quantity":1,"unit_price":7300,"time_left":"MEDIUM"},{"id":1014176572,"item":{"id":201466},"quantity":73,"unit_price":5231500,"time_left":"LONG"},{"id":1013295160,"item":{"id":39970},"quantity":1,"unit_price":230000,"time_left":"MEDIUM"},{"id":1016006143,"item":{"id":170554},"quantity":35,"unit_price":129900,"time_left":"VERY_LONG"},{"id":1014342041,"item":{"id":224314},"quantity":1,"unit_price":168100,"time_left":"LONG"},{"id":1012971559,"item":{"id":31910},"quantity":2,"unit_price":250000,"time_left":"MEDIUM"},{"id":1015907700,"item":{"id":223686},"quantity":3,"unit_price":64990000,"time_left":"VERY_LONG"},{"id":1013219642,"item":{"id":38846},"quantity":1,"unit_price":198000,"time_left":"MEDIUM"},{"id":1013681532,"item":{"id":202070},"quantity":3,"unit_price":824400,"time_left":"LONG"},{"id":1015157179,"item":{"id":220282},"quantity":15,"unit_price":20400,"time_left":"LONG"},{"id":1015329487,"item":{"id":8154},"quantity":1,"unit_price":7100,"time_left":"LONG"},{"id":1015793779,"item":{"id":192994},"quantity":1,"unit_price":6990000,"time_left":"VERY_LONG"},{"id":1013892385,"item":{"id":222682},"quantity":1,"unit_price":993200,"time_left":"LONG"},{"id":1015082046,"item":{"id":8766},"quantity":2,"unit_price":200,"time_left":"LONG"},{"id":1013590707,"item":{"id":116170},"quantity":300,"unit_price":21000,"time_left":"LONG"},{"id":1015580417,"item":{"id":2838},"quantity":1,"unit_price":900,"time_left":"VERY_LONG"},{"id":1013379017,"item":{"id":8846},"quantity":1,"unit_price":389900,"time_left":"LONG"},{"id":1013649091,"item":{"id":223722},"quantity":1,"unit_price":2741200,"time_left":"LONG"},{"id":1013084802,"item":{"id":222802},"quantity":4,"unit_price":1405300,"time_left":"MEDIUM"},{"id":1013200130,"item":{"id":200826},"quantity":3,"unit_price":725000,"time_left":"MEDIUM"},{"id":1015222397,"item":{"id":75014},"quantity":1,"unit_price":180000,"time_left":"LONG"},{"id":1013890139,"item":{"id":8766},"quantity":1,"unit_price":300,"time_left":"LONG"},{"id":1013957718,"item":{"id":219950},"quantity":2,"unit_price":789500,"time_left":"LONG"},{"id":1013887096,"item":{"id":72234},"quantity":66,"unit_price":6300,"time_left":"LONG"},{"id":1014786493,"item":{"id":36906},"quantity":3,"unit_price":80500,"time_left":"LONG"},{"id":1013613130,"item":{"id":220302},"quantity":1,"unit_price":19400,"time_left":"LONG"},{"id":1014491785,"item":{"id":220362},"quantity":6,"unit_price":3241500,"time_left":"LONG"},{"id":1015677247,"item":{"id":212674},"quantity":4,"unit_price":111000,"time_left":"VERY_LONG"},{"id":1015828997,"item":{"id":39682},"quantity":8,"unit_price":428100,"time_left":"VERY_LONG"},{"id":1015870203,"item":{"id":210802},"quantity":1,"unit_price":251900,"time_left":"VERY_LONG"},{"id":1015308263,"item":{"id":6522},"quantity":20,"unit_price":380000,"time_left":"LONG"},{"id":1014089417,"item":{"id":224826},"quantity":5,"unit_price":128100,"time_left":"LONG"},{"id":1012743291,"item":{"id":212674},"quantity":3,"unit_price":115200,"time_left":"SHORT"},{"id":1012865681,"item":{"id":219954},"quantity":5,"unit_price":955300,"time_left":"SHORT"},{"id":1014818486,"item":{"id":223762},"quantity":2,"unit_price":53950000,"time_left":"LONG"},{"id":1013758294,"item":{"id":225670},"quantity":1,"unit_price":1999500,"time_left":"LONG"},{"id":1015507410,"item":{"id":212498},"quantity":3,"unit_price":230000,"time_left":"VERY_LONG"},{"id":1013241863,"item":{"id":8846},"quantity":1,"unit_price":395600,"time_left":"MEDIUM"},{"id":1014048188,"item":{"id":23438},"quantity":1,"unit_price":455100,"time_left":"LONG"},{"id":1012929094,"item":{"id":8846},"quantity":1,"unit_price":404800,"time_left":"MEDIUM"},{"id":1015575542,"item":{"id":151542},"quantity":3,"unit_price":14000000,"time_left":"VERY_LONG"},{"id":1013923038,"item":{"id":188658},"quantity":12,"unit_price":290000,"time_left":"LONG"},{"id":1013819682,"item":{"id":160298},"quantity":7,"unit_price":800,"time_left":"LONG"},{"id":1015532375,"item":{"id":62518},"quantity":1,"unit_price":2300,"time_left":"VERY_LONG"},{"id":1014704134,"item":{"id":211474},"quantity":1,"unit_price":235500,"time_left":"LONG"},{"id":1013098518,"item":{"id":192614},"quantity":1,"unit_price":6300,"time_left":"MEDIUM"},{"id":1013398534,"item":{"id":213510},"quantity":1,"unit_price":439900,"time_left":"LONG"},{"id":1015941802,"item":{"id":210802},"quantity":2,"unit_price":250000,"time_left":"VERY_LONG"},{"id":1013720838,"item":{"id":222730},"quantity":30,"unit_price":8750000,"time_left":"LONG"},{"id":1015544194,"item":{"id":22526},"quantity":7,"unit_price":200,"time_left":"VERY_LONG"},{"id":1013778121,"item":{"id":192646},"quantity":1,"unit_price":15900,"time_left":"LONG"},{"id":1013081553,"item":{"id":774},"quantity":4,"unit_price":8000,"time_left":"MEDIUM"},{"id":1015444846,"item":{"id":160298},"quantity":2,"unit_price":800,"time_left":"LONG"},{"id":1013851010,"item":{"id":210930},"quantity":3,"unit_price":316800,"time_left":"LONG"},{"id":1014549346,"item":{"id":212498},"quantity":8,"unit_price":250000,"time_left":"LONG"},{"id":1014363030,"item":{"id":220138},"quantity":3,"unit_price":187700,"time_left":"LONG"},{"id":1013616874,"item":{"id":221906},"quantity":29,"unit_price":24556700,"time_left":"LONG"},{"id":1014422739,"item":{"id":197742},"quantity":3,"unit_price":400,"time_left":"LONG"},{"id":1013384253,"item":{"id":87806},"quantity":1,"unit_price":149300,"time_left":"LONG"},{"id":1013704769,"item":{"id":160502},"quantity":6,"unit_price":2900,"time_left":"LONG"},{"id":1012979627,"item":{"id":130178},"quantity":37,"unit_price":500000,"time_left":"MEDIUM"},{"id":1013954759,"item":{"id":192878},"quantity":96,"unit_price":811800,"time_left":"LONG"},{"id":1015397820,"item":{"id":4234},"quantity":20201,"unit_price":99900,"time_left":"LONG"},{"id":1013236674,"item":{"id":52722},"quantity":1,"unit_price":507500,"time_left":"MEDIUM"},{"id":1013016169,"item":{"id":194562},"quantity":1,"unit_price":14700,"time_left":"MEDIUM"},{"id":1015076707,"item":{"id":3358},"quantity":1,"unit_price":141400,"time_left":"LONG"},{"id":1013140462,"item":{"id":228510},"quantity":1,"unit_price":2885300,"time_left":"MEDIUM"},{"id":1013982573,"item":{"id":190538},"quantity":4,"unit_price":3990000,"time_left":"LONG"},{"id":1015836287,"item":{"id":153430},"quantity":1,"unit_price":8900,"time_left":"VERY_LONG"},{"id":1013188330,"item":{"id":43102},"quantity":2,"unit_price":325000,"time_left":"MEDIUM"},{"id":1013221962,"item":{"id":158874},"quantity":1,"unit_price":8566200,"time_left":"MEDIUM"},{"id":1013548802,"item":{"id":224802},"quantity":1,"unit_price":219900,"time_left":"LONG"},{"id":1014627794,"item":{"id":7910},"quantity":1,"unit_price":13600,"time_left":"LONG"},{"id":1012897897,"item":{"id":5470},"quantity":1,"unit_price":800,"time_left":"MEDIUM"},{"id":1013404732,"item":{"id":193470},"quantity":1,"unit_price":10000,"time_left":"LONG"},{"id":1015290101,"item":{"id":172054},"quantity":2,"unit_price":700,"time_left":"LONG"},{"id":1015540670,"item":{"id":113262},"quantity":2,"unit_price":12000,"time_left":"VERY_LONG"},{"id":1013434703,"item":{"id":75026},"quantity":14,"unit_price":6800,"time_left":"LONG"},{"id":1014614814,"item":{"id":211806},"quantity":4,"unit_price":25300,"time_left":"LONG"},{"id":1013919299,"item":{"id":2674},"quantity":3,"unit_price":211000,"time_left":"LONG"},{"id":1013647415,"item":{"id":187634},"quantity":1,"unit_price":4940000,"time_left":"LONG"},{"id":1014424096,"item":{"id":132514},"quantity":2,"unit_price":5490000,"time_left":"LONG"},{"id":1015147211,"item":{"id":8154},"quantity":1,"unit_price":7100,"time_left":"LONG"},{"id":1013306122,"item":{"id":160298},"quantity":75,"unit_price":800,"time_left":"MEDIUM"},{"id":1014216438,"item":{"id":5342},"quantity":5,"unit_price":1900,"time_left":"LONG"},{"id":1014447851,"item":{"id":173058},"quantity":4,"unit_price":850000,"time_left":"LONG"},{"id":1014869935,"item":{"id":213398},"quantity":4,"unit_price":939400,"time_left":"LONG"},{"id":1015777067,"item":{"id":179314},"quantity":1,"unit_price":800,"time_left":"VERY_LONG"},{"id":1013009172,"item":{"id":109138},"quantity":20,"unit_price":2500,"time_left":"MEDIUM"},{"id":1014587193,"item":{"id":1710},"quantity":9,"unit_price":2007000,"time_left":"LONG"},{"id":1012783926,"item":{"id":211806},"quantity":3,"unit_price":25100,"time_left":"SHORT"},{"id":1013922009,"item":{"id":197742},"quantity":3,"unit_price":400,"time_left":"LONG"},{"id":1013751767,"item":{"id":198162},"quantity":4,"unit_price":1409900,"time_left":"LONG"},{"id":1014670511,"item":{"id":197746},"quantity":3186,"unit_price":500,"time_left":"LONG"},{"id":1015271300,"item":{"id":190538},"quantity":57,"unit_price":3500000,"time_left":"LONG"},{"id":1013162028,"item":{"id":226202},"quantity":319,"unit_price":8400,"time_left":"MEDIUM"},{"id":1014363988,"item":{"id":27854},"quantity":1,"unit_price":6340300,"time_left":"LONG"},{"id":1014285231,"item":{"id":193950},"quantity":2,"unit_price":7700,"time_left":"LONG"},{"id":1015533927,"item":{"id":12202},"quantity":1,"unit_price":600,"time_left":"VERY_LONG"},{"id":1014086208,"item":{"id":774},"quantity":3,"unit_price":8000,"time_left":"LONG"},{"id":1014160007,"item":{"id":5498},"quantity":8,"unit_price":40000,"time_left":"LONG"},{"id":1013002261,"item":{"id":192858},"quantity":6,"unit_price":40000,"time_left":"MEDIUM"},{"id":1015268127,"item":{"id":6522},"quantity":3,"unit_price":380000,"time_left":"LONG"}]}

                      """;
        
        // Act
        var options = new JsonSerializerOptions(JsonSerializerDefaults.Web);
        options.Converters.Add(new RunningAuctionStatsBagJsonConverter());
        var result = JsonSerializer.Deserialize<RunningAuctionStatsBag>(payload, options);

        // Assert
        Assert.NotNull(result);
        Assert.NotEmpty(result.AuctionsStats);
        var multi = result.AuctionsStats.Values.Where(x => x.Count > 1).ToList();
        Assert.NotEmpty(multi);
        foreach (RunningAuctionStats auctionStats in multi)
        {
            Assert.True(auctionStats.Count > 1);
            Assert.True(auctionStats.RunningStats.Count > 0);
            Assert.True(double.IsNormal(auctionStats.RunningStats.Mean));
            if (auctionStats.RunningStats.Count > 2)
            {
                var variance = auctionStats.RunningStats.PopulationVariance;
                Assert.True(variance >= 0);
                Assert.True(double.IsNormal(variance) || variance == 0);
            }
            Assert.True(auctionStats.TDigest.Count > 0);
            Assert.True(double.IsNormal(auctionStats.TDigest.Min));
            Assert.True(double.IsNormal(auctionStats.TDigest.Max));
            Assert.True(double.IsNormal(auctionStats.TDigest.Quantile(0.5)));
            Assert.True(double.IsNormal(auctionStats.TDigest.Quantile(0.1)));
            Assert.True(double.IsNormal(auctionStats.TDigest.Quantile(0.9)));

            Guid h = RunningAuctionStatsBagHasher.GetHash(result, DateTimeOffset.UtcNow);
            Assert.NotEqual(h, Guid.Empty);
        }
    }
}